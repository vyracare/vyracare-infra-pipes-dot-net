name: CD - Auth - Deploy Terraform

on:
  workflow_call:
    inputs:
      branch-name:
        description: "Branch que disparou o deploy"
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_REGION:
        required: false
      PAT_TOKEN:
        required: true

jobs:
  deploy-terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve checkout ref
        id: resolve_checkout_ref
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const branch = process.env.BRANCH_NAME;
            if (!branch) {
              core.setOutput('ref', '');
              return;
            }

            try {
              await github.rest.repos.getBranch({
                owner: 'vyracare',
                repo: 'vyracare-infra-pipes-dot-net',
                branch,
              });
              core.setOutput('ref', branch);
            } catch (error) {
              if (error.status === 404) {
                core.info(`Branch ${branch} not found in vyracare/vyracare-infra-pipes-dot-net. Falling back to default branch.`);
                core.setOutput('ref', '');
              } else {
                throw error;
              }
            }
        env:
          BRANCH_NAME: ${{ inputs.branch-name }}

      - name: Checkout Infra (branch)
        if: steps.resolve_checkout_ref.outputs.ref != ''
        uses: actions/checkout@v4
        with:
          repository: vyracare/vyracare-infra-pipes-dot-net
          ref: ${{ steps.resolve_checkout_ref.outputs.ref }}
          token: ${{ secrets.PAT_TOKEN }}
          path: infra-repo

      - name: Checkout Infra (default)
        if: steps.resolve_checkout_ref.outputs.ref == ''
        uses: actions/checkout@v4
        with:
          repository: vyracare/vyracare-infra-pipes-dot-net
          token: ${{ secrets.PAT_TOKEN }}
          path: infra-repo

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2

      - name: Terraform Init
        run: terraform init
        working-directory: ./infra-repo/infra

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: ./infra-repo/infra

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: ./infra-repo/infra

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
