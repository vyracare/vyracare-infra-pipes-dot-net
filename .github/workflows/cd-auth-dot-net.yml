name: CD - Auth - Deploy Terraform

on:
  workflow_call:
    inputs:
      branch-name:
        description: "Branch do backend que disparou o deploy"
        required: true
        type: string
      backend-repo:
        description: "owner/repo do backend (ex: vyracare/vyracare-api-authentication)"
        required: true
        type: string
      project-path:
        description: "Caminho do .csproj no repo do backend"
        required: true
        type: string
      output-dir:
        description: "Diretório de saída do publish (relativo ao workspace do job)"
        required: false
        default: backend-publish
        type: string
    secrets:
      AWS_ACCESS_KEY_ID: { required: true }
      AWS_SECRET_ACCESS_KEY: { required: true }
      AWS_REGION: { required: false }
      PAT_TOKEN: { required: true }

jobs:
  deploy-terraform:
    runs-on: ubuntu-latest
    # ✅ Apenas UM bloco env no nível do job
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

    steps:
      - name: Resolve checkout ref
        id: resolve_checkout_ref
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const branch = process.env.BRANCH_NAME;
            if (!branch) {
              core.setOutput('ref', '');
              return;
            }
            try {
              await github.rest.repos.getBranch({
                owner: 'vyracare',
                repo: 'vyracare-infra-pipes-dot-net',
                branch,
              });
              core.setOutput('ref', branch);
            } catch (error) {
              if (error.status === 404) {
                core.info(`Branch ${branch} not found in vyracare/vyracare-infra-pipes-dot-net. Falling back to default branch.`);
                core.setOutput('ref', '');
              } else {
                throw error;
              }
            }
        env:
          BRANCH_NAME: ${{ inputs['branch-name'] }}

      - name: Checkout Infra (branch)
        if: steps.resolve_checkout_ref.outputs.ref != ''
        uses: actions/checkout@v4
        with:
          repository: vyracare/vyracare-infra-pipes-dot-net
          ref: ${{ steps.resolve_checkout_ref.outputs.ref }}
          token: ${{ secrets.PAT_TOKEN }}
          path: infra-repo

      - name: Checkout Infra (default)
        if: steps.resolve_checkout_ref.outputs.ref == ''
        uses: actions/checkout@v4
        with:
          repository: vyracare/vyracare-infra-pipes-dot-net
          token: ${{ secrets.PAT_TOKEN }}
          path: infra-repo

      - name: Checkout Backend at ref
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs['backend-repo'] }}
          ref: ${{ inputs['branch-name'] }}
          token: ${{ secrets.PAT_TOKEN }}
          path: backend

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore "backend/${{ inputs['project-path'] }}"

      - name: Build
        run: dotnet build "backend/${{ inputs['project-path'] }}" -c Release --no-restore

      - name: Publish (linux-x64)
        run: |
          mkdir -p "${{ inputs['output-dir'] }}"
          dotnet publish "backend/${{ inputs['project-path'] }}" -c Release -r linux-x64 --self-contained false -o "${{ inputs['output-dir'] }}"

      - name: Export publish dir to TF_VAR
        run: echo "TF_VAR_lambda_source_dir=${GITHUB_WORKSPACE}/${{ inputs['output-dir'] }}" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.2

      - name: Terraform Init
        working-directory: ./infra-repo/infra
        run: terraform init

      - name: Terraform Plan
        working-directory: ./infra-repo/infra
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./infra-repo/infra
        run: terraform apply -auto-approve tfplan
